var X=Object.defineProperty,Z=Object.defineProperties;var tt=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,nt=Object.prototype.propertyIsEnumerable;var F=(s,t,e)=>t in s?X(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,O=(s,t)=>{for(var e in t||(t={}))et.call(t,e)&&F(s,e,t[e]);if(K)for(var e of K(t))nt.call(t,e)&&F(s,e,t[e]);return s},J=(s,t)=>Z(s,tt(t));var f=(s,t,e)=>F(s,typeof t!="symbol"?t+"":t,e);var w=(s,t,e)=>new Promise((n,r)=>{var i=c=>{try{a(e.next(c))}catch(l){r(l)}},o=c=>{try{a(e.throw(c))}catch(l){r(l)}},a=c=>c.done?n(c.value):Promise.resolve(c.value).then(i,o);a((e=e.apply(s,t)).next())});function $$(s){let t=null;if(typeof s=="string"&&(t=document.querySelector(s)),s instanceof HTMLElement&&(t=s),t){const e=t.getAttribute("s:cn");if(e&&e!=""&&typeof window[e]=="function"){const n=new window[e](t);return new __sui_component(t,n)}}return null}function __sui_component_root(s,t){return s.closest(`[s\\:cn=${t}]`)}function __sui_state(s){this.handlers=s.watch||{},this.Set=function(t,e,n){return w(this,null,function*(){var i;const r=this.handlers[t];if(n=n||s.root,r&&typeof r=="function"){if(yield r(e,{target:n,stopPropagation:function(){n.setAttribute("state-propagation","true")}}),n?n.getAttribute("state-propagation")==="true":!1)return;let c=(i=s.root.parentElement)==null?void 0:i.closest("[s\\:cn]");if(c==null)return;const l=new CustomEvent("state:change",{detail:{key:t,value:e,target:s.root}});c.dispatchEvent(l)}})}}function __sui_props(s){this.Get=function(t){if(!s||typeof s.getAttribute!="function")return null;const e="prop:"+t,n=s.getAttribute(e);if(s.getAttribute("json-attr-prop:"+t)==="true")try{return JSON.parse(n)}catch(i){return null}return n},this.List=function(){const t={};if(!s||typeof s.getAttribute!="function")return t;const e=s.attributes;for(let n=0;n<e.length;n++){const r=e[n];if(r.name.startsWith("prop:")){const i=r.name.replace("prop:","");if(s.getAttribute("json-attr-prop:"+i)==="true"){try{t[i]=JSON.parse(r.value)}catch(a){t[i]=null}continue}t[i]=r.value}}return t}}function __sui_component(s,t){this.root=s,this.store=new __sui_store(s),this.props=new __sui_props(s),this.state=t?new __sui_state(t):{};const e=this;this.$root=new __Query(this.root),this.find=function(n){return new __Query(e.root).find(n)},this.query=function(n){return e.root.querySelector(n)},this.queryAll=function(n){return e.root.querySelectorAll(n)},this.emit=function(n,r){const i=new CustomEvent(n,{detail:r});e.root.dispatchEvent(i)},this.render=function(n,r,i){return new __Render(e,i).Exec(n,r)}}function __sui_event_handler(s,t,e,n,r,i){const o={};n=n||null,n&&(t.forEach(function(a){const c=n.getAttribute("data:"+a);o[a]=c}),e.forEach(function(a){const c=n.getAttribute("json:"+a);if(o[a]=null,c&&c!="")try{o[a]=JSON.parse(c)}catch(l){const u=l.message||l||"An error occurred";console.error(`[SUI] Event Handler Error: ${u} `,n)}})),i&&i(s,o,{rootElement:r,targetElement:n})}function __sui_event_init(s){const t=r=>{let i=r.getAttribute("s:event-cn")||"";const o=r.closest("[s\\:cn]");if(o&&(i=o.getAttribute("s:cn")||""),i==""){console.error("[SUI] Component name is required for event binding",s);return}const a={},c=[],l=[];for(let u=0;u<r.attributes.length;u++)if(r.attributes[u].name.startsWith("data:")&&c.push(r.attributes[u].name.replace("data:","")),r.attributes[u].name.startsWith("json:")&&l.push(r.attributes[u].name.replace("json:","")),r.attributes[u].name.startsWith("s:on-")){const p=r.attributes[u].name.replace("s:on-","");a[p]=r.attributes[u].value}for(const u in a){const p=a[u];if(i=="__page"){const x=window[p],k=document.body,d=r;r.addEventListener(u,h=>{__sui_event_handler(h,c,l,d,k,x)});continue}const H=r.closest(`[s\\:cn=${i}]`);if(typeof window[i]!="function"){console.error(`[SUI] Component ${i} not found`,r);return}const P=new window[i](H),j=P[p],m=P.root,T=r;r.addEventListener(u,x=>{__sui_event_handler(x,c,l,T,m,j)})}},e=s.querySelectorAll("[s\\:event]"),n=s.querySelectorAll("[s\\:event-jit]");e.forEach(r=>t(r)),n.forEach(r=>t(r))}function __sui_store(s){s=s||document.body,this.Get=function(t){return s.getAttribute("data:"+t)},this.Set=function(t,e){s.setAttribute("data:"+t,e)},this.GetJSON=function(t){const e=s.getAttribute("json:"+t);if(e&&e!="")try{return JSON.parse(e)}catch(n){const r=n.message||n||"An error occurred";return console.error(`[SUI] Event Handler Error: ${r}`,s),null}return null},this.SetJSON=function(t,e){s.setAttribute("json:"+t,JSON.stringify(e))},this.GetData=function(){return this.GetJSON("__component_data")||{}}}function __sui_backend_call(s,t,e,...n){return w(this,null,function*(){const r=`/api/__yao/sui/v1/run${s}`;t=O({"Content-Type":"application/json",Referer:window.location.href,Cookie:document.cookie},t);const i={method:e,args:n};try{const o=JSON.stringify(i),a=yield fetch(r,{method:"POST",headers:t,body:o}),c=yield a.text();let l=null;if(c&&c!=""&&(l=JSON.parse(c)),a.status>=400){const u=l.message?l.message:`Failed to call ${s} ${e}`,p=l.code?l.code:500;return Promise.reject({message:u,code:p})}return Promise.resolve(l)}catch(o){const a=o.message?o.message:`Failed to call ${s} ${e}`,c=o.code?o.code:500;return console.error(`[SUI] Failed to call ${s} ${e}:`,o),Promise.reject({message:a,code:c})}})}function __sui_render(s,t,e,n){return w(this,null,function*(){const r=typeof s=="object"?s:$$(s);if(r==null)return console.error(`[SUI] Component not found: ${s}`),Promise.reject("Component not found");const i=r.root.querySelectorAll(`[s\\:render=${t}]`);if(!i.length)return console.error(`[SUI] No element found with s:render=${t}`),Promise.reject("No element found");n=n||{},n.replace=n.replace===void 0?!0:n.replace,n.showLoader=n.showLoader===void 0?!1:n.showLoader,n.withPageData=n.withPageData===void 0?!1:n.withPageData;let o='<span class="sui-render-loading">Loading...</span>';n.showLoader&&n.replace&&(typeof n.showLoader=="string"?o=n.showLoader:n.showLoader instanceof HTMLElement&&(o=n.showLoader.outerHTML),i.forEach(m=>m.innerHTML=o));let a=r.store.GetData()||{};n.withPageData&&(a=O(O({},a),__sui_data));const c=r.root.closest("[s\\:route]"),l=c?c.getAttribute("s:route"):!1,u=document.body.getAttribute("s:public")||"",p=l?`${u}${l}`:n.route||window.location.pathname;n.component=l&&r.root.getAttribute("s:cn")||"";const H=`/api/__yao/sui/v1/render${p}`,P={name:t,data:a,option:n};if(e)for(const m in e)P.data[m]=e[m];const j={"Content-Type":"application/json",Cookie:document.cookie};try{const m=JSON.stringify(P),x=yield(yield fetch(H,{method:"POST",headers:j,body:m})).text();return n.replace&&i.forEach(k=>{k.innerHTML=x,k.querySelectorAll("[s\\:cn]").forEach(h=>{const S=h.getAttribute("s:ready"),y=h.getAttribute("s:cn");if(S&&y&&typeof window[y]=="function")try{new window[y](h)}catch(v){const $=v.message||v||"An error occurred";console.error(`[SUI] ${y} Error: ${$}`)}});try{__sui_event_init(k)}catch(h){const S=h.message||"Failed to init events";Promise.reject(S)}}),Promise.resolve(x)}catch(m){return i.forEach(T=>{T.innerHTML='<span class="sui-render-error">Failed to render</span>',console.error("Failed to render",m)}),Promise.reject("Failed to render")}})}function $Store(s){if(!s)return null;if(typeof s=="string"){if(s=document.querySelectorAll(s),s.length==0)return null;s=s[0]}return new __sui_store(s)}function $Query(s){return new __Query(s)}class __Query{constructor(t){f(this,"selector","");f(this,"elements",null);f(this,"element",null);typeof t=="string"?(this.selector=t,this.elements=document.querySelectorAll(t),this.elements.length>0&&(this.element=this.elements[0])):t instanceof NodeList?(this.elements=t,this.elements.length>0&&(this.element=this.elements[0])):this.element=t,this.selector=t}elm(){return this.element}elms(){return this.elements}find(t){var n;const e=(n=this.element)==null?void 0:n.querySelector(t);return e?new __Query(e):null}findAll(t){var n;const e=(n=this.element)==null?void 0:n.querySelectorAll(t);return e?new __Query(e):null}closest(t){var n;const e=(n=this.element)==null?void 0:n.closest(t);return e?new __Query(e):null}on(t,e){return this.element?(this.element.addEventListener(t,e),this):this}$$(){if(!this.element)return null;const t=this.element.closest("[s\\:cn]");return t?$$(t):null}each(t){this.elements&&this.elements.forEach((e,n)=>{t(new __Query(e),n)})}store(){return!this.element||typeof this.element.getAttribute!="function"?null:new __sui_store(this.element)}attr(t){return!this.element||typeof this.element.getAttribute!="function"?null:this.element.getAttribute(t)}data(t){return!this.element||typeof this.element.getAttribute!="function"?null:this.element.getAttribute("data:"+t)}json(t){if(!this.element||typeof this.element.getAttribute!="function")return null;const e=this.element.getAttribute("json:"+t);if(!e)return null;try{return JSON.parse(e)}catch(n){return console.error(`Error parsing JSON for key ${t}: ${n}`),null}}prop(t){if(!this.element||typeof this.element.getAttribute!="function")return null;const e="prop:"+t,n=this.element.getAttribute(e);if(this.element.getAttribute("json-attr-prop:"+t)==="true"&&n)try{return JSON.parse(n)}catch(i){return console.error(`Error parsing JSON for prop ${t}: ${i}`),null}return n}hasClass(t){var e;return(e=this.element)==null?void 0:e.classList.contains(t)}toggleClass(t){const e=Array.isArray(t)?t:t==null?void 0:t.split(" ");return e==null||e.forEach(n=>{var i;const r=n.replace(/[\n\r\s]/g,"");r!==""&&((i=this.element)==null||i.classList.toggle(r))}),this}removeClass(t){const e=Array.isArray(t)?t:t==null?void 0:t.split(" ");return e==null||e.forEach(n=>{var i;const r=n.replace(/[\n\r\s]/g,"");r!==""&&((i=this.element)==null||i.classList.remove(r))}),this}addClass(t){const e=Array.isArray(t)?t:t==null?void 0:t.split(" ");return e==null||e.forEach(n=>{var i;const r=n.replace(/[\n\r\s]/g,"");r!==""&&((i=this.element)==null||i.classList.add(r))}),this}html(t){var e;return t===void 0?((e=this.element)==null?void 0:e.innerHTML)||"":(this.element&&(this.element.innerHTML=t),this)}}function $Render(s,t){return new __Render(s,t)}class __Render{constructor(t,e){f(this,"comp",null);f(this,"option",null);this.comp=t,this.option=e}Exec(t,e){return w(this,null,function*(){return __sui_render(this.comp,t,e,this.option)})}}function $Backend(s,t){const e=document.body.getAttribute("s:public")||"/";s=s||window.location.pathname;const n=new RegExp("^"+e);return s=e+s.replace(n,""),new __Backend(s,t)}class __Backend{constructor(t,e={}){f(this,"route","");f(this,"headers",{});this.route=t,this.headers=e}Call(t,...e){return w(this,null,function*(){return yield __sui_backend_call(this.route,this.headers,t,...e)})}}function Yao(s){this.host=`${s||window.location.protocol+"//"+window.location.host}/api`,this.query={},new URLSearchParams(window.location.search).forEach((t,e)=>{this.query[t]=e})}Yao.prototype.Get=function(s,t,e){return w(this,null,function*(){return this.Fetch("GET",s,t,null,e)})},Yao.prototype.Post=function(s,t,e,n){return w(this,null,function*(){return this.Fetch("POST",s,e,t,n)})},Yao.prototype.Download=function(s,t,e,n){return w(this,null,function*(){try{const i=yield this.Fetch("GET",s,t,null,n,!0);var r=window.URL.createObjectURL(i);let o=document.createElement("a");document.body.appendChild(o),o.href=r,o.download=e,o.click(),window.URL.revokeObjectURL(r)}catch(i){alert("\u6210\u529F\u521B\u5EFA\u5BFC\u51FA\u4EFB\u52A1!")}})},Yao.prototype.Fetch=function(s,t,e,n,r,i){return w(this,null,function*(){e=e||{},r=r||{},n=n||null;var o=`${this.host}${t}`,a=this.Serialize(e);a!=""&&(o=o.includes("?")?`${o}&${a}`:`${o}?${a}`);const c=this.Token();c!=""&&(r.authorization=`Bearer ${c}`),r["Content-Type"]||(r["Content-Type"]="application/json");var l={method:s,mode:"cors",cache:"no-cache",credentials:"same-origin",headers:r,redirect:"follow"};n!=null&&(l.body=JSON.stringify(n));const u=yield fetch(o,l),p=u.headers.get("Content-Type")||"";if(p.includes("application/json"))try{return yield u.json()}catch(H){return{code:u.status,message:"empty return"}}else{if(i)return u.blob();if(p.includes("text/html")||p.includes("text/plain"))return u.text()}return u.text()})},Yao.prototype.Token=function(){var s=sessionStorage.getItem("token")||"";return s==""?this.Cookie("__tk")||"":s},Yao.prototype.Cookie=function(s){for(var t=s+"=",e=decodeURIComponent(document.cookie),n=e.split(";"),r=0;r<n.length;r++){var i=n[r].trim();if(i.indexOf(t)===0)return i.substring(t.length,i.length)}return null},Yao.prototype.SetCookie=function(s,t,e){e=e||30;var n=new Date;n.setTime(n.getTime()+e*24*60*60*1e3);var r="expires="+n.toUTCString();document.cookie=`${s}=${t};${r};path=/`},Yao.prototype.DeleteCookie=function(s){document.cookie=`${s}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`},Yao.prototype.Serialize=function(s){const t=[];for(const e in s)s.hasOwnProperty(e)&&t.push(encodeURIComponent(e)+"="+encodeURIComponent(s[e]));return t.join("&")};class Agent{constructor(t,e){f(this,"host");f(this,"token");f(this,"events");f(this,"assistant_id");f(this,"chat_id");f(this,"es");f(this,"context");f(this,"silent",!1);f(this,"history_visible",!1);this.host=e.host||"/api/__yao/neo",this.token=e.token,this.events={},this.assistant_id=t,this.chat_id=e.chat_id,this.es=null,this.context=e.context||{},e.silent!==void 0&&(this.silent=!(e.silent===!0||e.silent==="true"||e.silent===1||e.silent==="1")),e.history_visible!==void 0&&(this.history_visible=e.history_visible===!0||e.history_visible==="true"||e.history_visible===1||e.history_visible==="1")}makeChatID(){const t=Math.random().toString(36).substring(2,15);return`chat_${Date.now()}_${t}`}On(t,e){return t==="message"?this.events.message=e:t==="done"&&(this.events.done=e),this}Cancel(){this.es&&(this.es.close(),this.es=null)}Call(t,...e){return w(this,null,function*(){return new Promise((n,r)=>{const i=[];let o={assistant_id:null,assistant_name:null,assistant_avatar:null},a;typeof t=="string"?a={text:t}:(a={text:t.text},t.attachments&&t.attachments.length>0&&(a.attachments=t.attachments.map(d=>({name:d.name,url:d.url,type:d.type,content_type:d.content_type,bytes:d.bytes,created_at:d.created_at,file_id:d.file_id,chat_id:d.chat_id,assistant_id:d.assistant_id,description:d.description}))));const c=J(O({},this.context),{args:e}),l=encodeURIComponent(JSON.stringify(a)),u=encodeURIComponent(JSON.stringify(c)),p=this.token,H=this.silent?"true":"false",P=this.history_visible?"true":"false",j=this.chat_id||this.makeChatID(),m=`&assistant_id=${this.assistant_id}`,T=`${this.host}/status?content=${l}&context=${u}&token=${p}&chat_id=${j}${m}`,x=`${this.host}?client_type=jssdk&content=${l}&context=${u}&token=${p}&silent=${H}&history_visible=${P}&chat_id=${j}${m}`,k=d=>w(this,null,function*(){var h,S,y,v;try{const $=yield fetch(T,{credentials:"include",headers:{Accept:"application/json"}});if($.status===200||$.status===201)return;const C=yield $.json().catch(()=>({message:`HTTP ${$.status}`}));let g="Network error, please try again later";C!=null&&C.message?g=C.message:(h=d.message)!=null&&h.includes("401")?g="Session expired: Please login again":(S=d.message)!=null&&S.includes("403")?g="Access denied: Please check your permissions or login again":(y=d.message)!=null&&y.includes("500")?g="Server error: The service is temporarily unavailable":(v=d.message)!=null&&v.includes("404")?g="AI service not found: Please check your configuration":d.name==="TypeError"&&(g="Connection failed: Please check your network connection");const I=this.events.message;return I&&I({text:g,type:"error",is_neo:!0,done:!0}),r(new Error(g))}catch($){const C=this.events.message;return C&&C({text:"Service unavailable, please try again later",type:"error",is_neo:!0,done:!0}),r(new Error("Service unavailable, please try again later"))}});try{let d=null;const h=new EventSource(x,{withCredentials:!0});this.es=h,h.onopen=()=>{},h.onmessage=({data:S})=>{try{const y=JSON.parse(S);if(!y)return;const v=this.events.message;if(!v)return;const{tool_id:$,begin:C,type:g,end:I,text:b,props:L,done:R,assistant_id:U,assistant_name:G,assistant_avatar:Q,new:W,delta:z,result:M}=y;if(g==="action"){const{namespace:A,primary:E,data_item:D,action:q,extra:V}=L||{};if(q&&Array.isArray(q)){const B={text:b||"",type:"action",props:{namespace:A||"chat",primary:E||"id",data_item:D||{},action:q,extra:V},is_neo:!0,done:!!R};if(i.push(B),v(B),R){const N=this.events.done;N==null||N(i),h.close()}return n(M)}}const Y=g!==d&&(!R||R===!0&&(b||L))||i.length===0||U&&i[i.length-1].assistant_id!==U||W&&!z;if(d=g,U&&(o.assistant_id=U),G&&(o.assistant_name=G),Q&&(o.assistant_avatar=Q),Y){i.length>0&&i[i.length-1].is_neo&&(i[i.length-1]=J(O({},i[i.length-1]),{done:!0}));const A={text:b||"",type:g||"text",props:L,is_neo:!0,new:W,tool_id:$,result:M,assistant_id:o.assistant_id||void 0,assistant_name:o.assistant_name||void 0,assistant_avatar:o.assistant_avatar||void 0};if(i.push(A),v(A),R){const E=this.events.done;return E==null||E(i),h.close(),n(M)}return}const _=i[i.length-1];if(i.length>1){const A=i[i.length-2];A.assistant_id&&(_.previous_assistant_id=A.assistant_id)}if(R){b&&(_.text=b),g&&(_.type=g),L&&(_.props=L),M&&(_.result=M);for(let E=i.length-1;E>=0;E--){const D=i[E];if(D.is_neo){if(D.done)break;i[E]=J(O({},D),{done:!0})}}const A=this.events.done;return A==null||A(i),h.close(),n(M)}if(!b&&!L&&!g)return;L&&(g==="think"||g==="tool"?_.props=J(O({},_.props||{}),{id:$,begin:C,end:I}):_.props=L),b&&(z?(_.text=(_.text||"")+b,b.startsWith("\r")&&(_.text=b.replace("\r",""))):_.text=b),v(_)}catch(y){const v=y.message||JSON.stringify(y)||"\u672A\u77E5\u9519\u8BEF";console.error("Failed to parse message:",y),r(new Error(v))}},h.onerror=S=>{k(S),h.close()}}catch(d){k(d)}})})}}

//# sourceMappingURL=libsui.min.js.map